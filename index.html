<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Cooker</title>
    <style>
        :root {
            /* Neumorphism Design System */
            --neu-bg: #E8ECEF;
            --neu-light: #ffffff;
            --neu-dark: #a3b1c6;
            --neu-shadow: 9px 9px 16px rgba(163,177,198,0.6), -9px -9px 16px rgba(255,255,255,0.5);
            --neu-shadow-sm: 5px 5px 10px rgba(163,177,198,0.5), -5px -5px 10px rgba(255,255,255,0.5);
            --neu-shadow-xs: 3px 3px 6px rgba(163,177,198,0.45), -3px -3px 6px rgba(255,255,255,0.45);
            --neu-inset: inset 4px 4px 8px rgba(163,177,198,0.5), inset -4px -4px 8px rgba(255,255,255,0.6);
            --neu-inset-sm: inset 2px 2px 5px rgba(163,177,198,0.4), inset -2px -2px 5px rgba(255,255,255,0.5);

            /* Theme Colors */
            --theme-color: #a8c5a0;
            --accent-color: #3a4556;
            --text-primary: #3a4556;
            --text-secondary: #6b7a8d;
            --text-muted: #8895a7;
            --hover-color: rgba(163, 177, 198, 0.2);
            --dark-theme-color: #5a7a52;
            --header-text-color: #3a4556;
            --onboarding-btn-color: var(--neu-bg);
            --onboarding-btn-active: var(--theme-color);
            --widget-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "SF Pro Display", sans-serif;
        }

        * { box-sizing: border-box; font-family: var(--widget-font); letter-spacing: -0.01em; margin: 0; padding: 0; }
        html { background: #E8ECEF; }
        body { margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #E8ECEF; padding: 20px; }

        /* Main Layout */
        .main-layout { display: flex; flex-direction: row; align-items: flex-start; justify-content: center; gap: 40px; width: 100%; max-width: 900px; }
        @media (max-width: 700px), (max-height: 600px) and (max-width: 500px) {
            .main-layout { flex-direction: column; align-items: center; gap: 25px; }
        }

        /* Setup Window - Fixed colors (not affected by theme) */
        .window {
            --setup-bg: #E8ECEF;
            --setup-shadow: 8px 8px 16px rgba(174,184,194,0.5), -8px -8px 16px rgba(255,255,255,0.7);
            --setup-shadow-sm: 5px 5px 10px rgba(174,184,194,0.45), -5px -5px 10px rgba(255,255,255,0.65);
            --setup-shadow-xs: 3px 3px 6px rgba(174,184,194,0.4), -3px -3px 6px rgba(255,255,255,0.6);
            --setup-inset: inset 4px 4px 8px rgba(174,184,194,0.4), inset -4px -4px 8px rgba(255,255,255,0.6);
            --setup-inset-sm: inset 2px 2px 4px rgba(174,184,194,0.35), inset -2px -2px 4px rgba(255,255,255,0.55);
            --setup-text: #3a4556;
            --setup-text-secondary: #6b7a8d;
            --setup-text-muted: #8895a7;
            width: 100%; max-width: 420px; background: var(--setup-bg); border-radius: 24px; box-shadow: var(--setup-shadow); overflow: hidden; border: none; display: flex; flex-direction: column; z-index: 10; flex-shrink: 0;
        }
        .window .title-bar { height: 54px; background: var(--setup-bg); display: flex; align-items: center; padding: 0 18px; border-bottom: 1px solid rgba(163,177,198,0.25); }
        .window .bar-title { color: var(--setup-text); }
        .window .content { background: var(--setup-bg); }
        .window .nav-btn { background: var(--setup-bg); color: var(--setup-text); box-shadow: var(--setup-shadow-xs); }
        .window .nav-btn:hover { box-shadow: 2px 2px 4px rgba(174,184,194,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .window .nav-btn:active, .window .nav-btn.active { box-shadow: var(--setup-inset-sm); }
        .window input, .window select { background: var(--setup-bg); box-shadow: var(--setup-inset-sm); color: var(--setup-text); }
        .window input:focus, .window select:focus { box-shadow: inset 3px 3px 6px rgba(174,184,194,0.5), inset -3px -3px 6px rgba(255,255,255,0.6); }
        .window .label-text { color: var(--setup-text-muted); }
        .window .option-group > label { color: var(--setup-text-muted); }
        .window .option-btn { background: var(--setup-bg); color: var(--setup-text-secondary); box-shadow: var(--setup-shadow-xs); }
        .window .option-btn:hover { box-shadow: 2px 2px 4px rgba(174,184,194,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .window .option-btn.active { box-shadow: var(--setup-inset); color: var(--setup-text); }
        .window .color-dot { box-shadow: var(--setup-shadow-xs); }
        .window .color-dot.active { box-shadow: var(--setup-inset), 0 0 0 3px var(--theme-color); }
        .window .url-box { background: var(--setup-bg); box-shadow: var(--setup-inset-sm); }
        .window .url-box .url-text { background: var(--setup-bg); box-shadow: var(--setup-shadow-xs); color: var(--setup-text); }
        .window h1 { color: var(--setup-text); }
        .window p { color: var(--setup-text-secondary); }
        .title-bar { height: 54px; background: #E8ECEF; display: flex; align-items: center; padding: 0 18px; border-bottom: 1px solid rgba(163,177,198,0.25); }
        .dots { display: flex; gap: 7px; flex: 1; }
        .dot { width: 11px; height: 11px; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1), 1px 1px 2px rgba(255,255,255,0.5); }
        .dot.red { background: #d4a0a0; } .dot.yellow { background: #d4d4a0; } .dot.green { background: #a0c8a0; }
        .bar-title { font-size: 13px; font-weight: 700; color: var(--text-primary); flex: 2; text-align: center; letter-spacing: 0.05em; }
        .nav-controls { flex: 1; display: flex; justify-content: flex-end; gap: 10px; }
        .nav-btn { background: var(--neu-bg); border: none; cursor: pointer; color: var(--text-primary); padding: 7px; display: flex; align-items: center; justify-content: center; border-radius: 10px; box-shadow: var(--neu-shadow-xs); transition: all 0.2s ease; }
        .nav-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .nav-btn:active { box-shadow: var(--neu-inset-sm); }
        .nav-btn.active { box-shadow: var(--neu-inset-sm); color: var(--text-primary); }
        .nav-btn:disabled { opacity: 0.25; cursor: default; box-shadow: none; }
        .content { padding: 30px 25px; min-height: 300px; position: relative; background: var(--neu-bg); overflow-y: auto; }
        .step { display: none; animation: fadeUp 0.3s ease; }
        .step.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        h1 { font-size: 20px; font-weight: 800; margin: 0 0 8px; color: var(--text-primary); }
        p { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }

        /* Form Elements */
        .label-text { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.05em; }
        input, select { width: 100%; padding: 12px 14px; border-radius: 12px; border: none; background: var(--neu-bg); outline: none; font-size: 13px; margin-bottom: 12px; box-shadow: var(--neu-inset-sm); color: var(--text-primary); transition: all 0.3s ease; -webkit-appearance: none; appearance: none; }
        select { cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7a8d' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
        input:focus, select:focus { box-shadow: inset 3px 3px 6px rgba(163,177,198,0.55), inset -3px -3px 6px rgba(255,255,255,0.65); }
        input::placeholder { color: #9ba8b8; }
        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: none; box-shadow: var(--neu-shadow-xs); transition: all 0.2s ease; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { box-shadow: var(--neu-inset), 0 0 0 3px var(--theme-color); }
        .option-group { margin-bottom: 18px; }
        .option-group > label { font-size: 11px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .option-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .option-btn { flex: 1; padding: 14px 10px; border: none; border-radius: 14px; background: var(--neu-bg); font-size: 12px; cursor: pointer; text-align: center; transition: all 0.2s ease; color: var(--text-secondary); box-shadow: var(--neu-shadow-xs); font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .option-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .option-btn.active { box-shadow: var(--neu-inset); color: var(--text-primary); }
        .time-range-group { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
        .time-range-group select { flex: 1; padding: 10px; font-size: 11px; }
        .url-box { background: var(--neu-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: var(--neu-inset-sm); }
        .url-box label { font-size: 11px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px; text-transform: uppercase; }
        .url-box .url-text { font-size: 10px; color: var(--text-primary); word-break: break-all; background: var(--neu-bg); padding: 10px; border-radius: 10px; border: none; max-height: 50px; overflow-y: auto; box-shadow: var(--neu-shadow-xs); line-height: 1.6; font-family: monospace; }
        .copy-btn { width: 100%; background: var(--theme-color); color: #fff; border: none; padding: 13px 16px; border-radius: 14px; font-size: 13px; cursor: pointer; margin-top: 10px; box-shadow: var(--neu-shadow-xs); font-weight: 700; transition: all 0.2s ease; }
        .copy-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .copy-btn:active { box-shadow: var(--neu-inset-sm); }

        /* Preview Section */
        .preview-section { display: flex; flex-direction: column; align-items: center; gap: 16px; max-width: 520px; }
        .preview-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .preview-row { display: flex; gap: 14px; justify-content: center; align-items: flex-start; flex-wrap: wrap; }
        .preview-widgets { display: flex; flex-direction: column; gap: 14px; align-items: center; }
        .timeline-previews { display: flex; gap: 12px; align-items: flex-end; }
        .timeline-preview-label { font-size: 8px; color: var(--text-muted); text-align: center; margin-top: 6px; font-weight: 600; text-transform: uppercase; }

        /* Widget Frame */
        .widget-frame { width: 240px !important; height: 175px !important; background: var(--neu-bg); border-radius: 24px; box-shadow: var(--neu-shadow); overflow: hidden; display: flex; flex-direction: column; border: none; position: relative; transition: all 0.5s ease; }
        .widget-frame.timeline-widget { width: 90px !important; height: 360px !important; }
        .widget-frame.timeline-widget.horizontal { width: 100% !important; max-width: 600px !important; height: 160px !important; }
        .widget-frame.calendar-widget { width: 200px !important; height: 240px !important; }
        .widget-frame.todo-widget { width: 240px !important; height: 220px !important; }
        .widget-top { height: 36px; background: var(--theme-color); display: flex; align-items: center; padding: 0 12px; transition: 0.3s; position: relative; flex-shrink: 0; border-radius: 0; }
        .widget-top.hidden { display: none; }
        .w-dots { display: flex; gap: 5px; position: absolute; left: 12px; }
        .w-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.3); box-shadow: inset 1px 1px 2px rgba(0,0,0,0.1); }
        .w-title { font-size: 11px; font-weight: 700; color: var(--header-text-color); width: 100%; text-align: center; cursor: pointer; }

        /* Refresh Button - unified position: top right */
        /* Old refresh button - hidden */
        .refresh-btn { display: none; }

        /* Header refresh button - inside top bar */
        .header-refresh-btn { background: transparent; border: none; cursor: pointer; color: var(--header-text-color); opacity: 0.6; transition: all 0.2s; padding: 4px; border-radius: 6px; display: flex; align-items: center; justify-content: center; position: absolute; right: 10px; }
        .header-refresh-btn:hover { opacity: 1; }
        .header-refresh-btn svg { width: 12px; height: 12px; }
        .header-refresh-btn.spinning svg { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Home Screen Clock */
        .widget-home { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--neu-bg); }
        .current-time { font-size: 36px; font-weight: 700; color: var(--text-primary); line-height: 0.9; margin-bottom: 4px; letter-spacing: -0.02em; }
        .current-date { font-size: 9px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-bottom: 14px; letter-spacing: 0.03em; }
        .action-btn { background: var(--theme-color); border: none; padding: 8px 16px; border-radius: 14px; font-size: 10px; color: #fff; cursor: pointer; font-weight: 700; transition: all 0.2s ease; box-shadow: var(--neu-shadow-xs); }
        .action-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .action-btn:active { box-shadow: var(--neu-inset-sm); }
        .action-btns { display: flex; gap: 8px; }

        /* Setup Widget Form Styles */
        .setup-form { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; min-height: 0; background: var(--neu-bg); }
        .setup-form-header { display: flex; align-items: center; margin-bottom: 6px; flex-shrink: 0; }
        .back-btn { background: var(--neu-bg); border: none; cursor: pointer; padding: 7px; color: var(--text-secondary); border-radius: 10px; box-shadow: var(--neu-shadow-xs); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .back-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .back-btn:active { box-shadow: var(--neu-inset-sm); }
        .form-type-btns { display: flex; gap: 6px; flex: 1; justify-content: center; }
        .form-type-btn { padding: 6px 14px; border: none; border-radius: 12px; background: var(--neu-bg); font-size: 10px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; box-shadow: var(--neu-shadow-xs); font-weight: 600; }
        .form-type-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .form-type-btn.active { box-shadow: var(--neu-inset); color: var(--text-primary); }
        .mini-input { width: 100%; padding: 10px 12px; font-size: 11px; border-radius: 10px; border: none; margin-bottom: 6px; background: var(--neu-bg); box-shadow: var(--neu-inset-sm); color: var(--text-primary); transition: all 0.2s; }
        .mini-input:focus { box-shadow: inset 3px 3px 6px rgba(163,177,198,0.55), inset -3px -3px 6px rgba(255,255,255,0.65); outline: none; }
        .mini-select { width: 100%; padding: 10px 12px; font-size: 11px; border-radius: 10px; border: none; margin-bottom: 6px; background: var(--neu-bg); box-shadow: var(--neu-inset-sm); color: var(--text-primary); cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%236b7a8d' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; -webkit-appearance: none; appearance: none; }
        .mini-cat-btn { padding: 8px 12px; font-size: 10px; border: none; border-radius: 10px; background: var(--neu-bg); cursor: pointer; margin-left: 4px; box-shadow: var(--neu-shadow-xs); color: var(--text-secondary); transition: all 0.2s; font-weight: 600; }
        .mini-cat-btn:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .mini-cat-btn:active { box-shadow: var(--neu-inset-sm); }
        .mini-cat-btn.danger { color: #e57373; }
        .mini-cat-btn.danger:hover { background: rgba(229, 115, 115, 0.1); }
        .form-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
        .form-row .mini-input { flex: 1; margin-bottom: 0; }
        .form-label { font-size: 9px; color: var(--text-muted); min-width: 28px; font-weight: 600; }
        .form-check { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer; }
        .form-check input[type="checkbox"] { -webkit-appearance: none; appearance: none; width: 18px !important; height: 18px !important; border-radius: 6px; cursor: pointer; background: var(--neu-bg); border: none; position: relative; box-shadow: var(--neu-inset-sm); transition: all 0.2s ease; flex-shrink: 0; padding: 0 !important; margin: 0 !important; }
        .form-check input[type="checkbox"]:checked { box-shadow: var(--neu-inset); }
        .form-check input[type="checkbox"]:checked::after { content: '\2713'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 700; color: var(--text-primary); }
        .btn-row { display: flex; gap: 10px; margin-top: 12px; flex-shrink: 0; padding-top: 6px; }
        .btn-row button { flex: 1; padding: 10px; font-size: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s ease; }
        .btn-save { background: var(--theme-color); color: #fff; box-shadow: var(--neu-shadow-xs); }
        .btn-save:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .btn-save:active { box-shadow: var(--neu-inset-sm); }
        .btn-cancel { background: var(--neu-bg); color: var(--text-secondary); box-shadow: var(--neu-shadow-xs); }
        .btn-cancel:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .btn-cancel:active { box-shadow: var(--neu-inset-sm); }

        /* Routine repeat options */
        .repeat-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .repeat-day { width: 28px; height: 28px; border-radius: 50%; border: none; background: var(--neu-bg); font-size: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.15s; box-shadow: var(--neu-shadow-xs); font-weight: 600; }
        .repeat-day:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .repeat-day:active, .repeat-day.active { box-shadow: var(--neu-inset-sm); transform: scale(0.95); }
        .repeat-day.active { color: var(--text-primary); }

        /* Todo Widget Styles */
        .todo-header { padding: 8px 10px; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgba(163,177,198,0.25); flex-shrink: 0; gap: 8px; background: var(--neu-bg); }
        .todo-tab { padding: 8px 16px; border: none; border-radius: 12px; background: var(--neu-bg); font-size: 10px; cursor: pointer; color: var(--text-secondary); font-weight: 600; transition: all 0.2s; box-shadow: var(--neu-shadow-xs); }
        .todo-tab:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .todo-tab.active { box-shadow: var(--neu-inset); color: var(--text-primary); }
        .todo-container { flex: 1; overflow-y: auto; padding: 8px 10px; min-height: 0; background: var(--neu-bg); }
        .task-section { margin-bottom: 6px; }
        .task-section-divider { height: 1px; background: rgba(163,177,198,0.25); margin: 10px 0; }
        .task-card { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--neu-bg); border-radius: 14px; font-size: 11px; margin-bottom: 8px; cursor: default; box-shadow: var(--neu-shadow-xs); transition: all 0.2s ease; color: var(--text-primary); }
        .task-card:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .task-card:active { box-shadow: var(--neu-inset-sm); }
        .task-card.done { opacity: 0.6; }
        .task-card.done .task-title { text-decoration: line-through; color: var(--text-muted); }
        .task-card .star { cursor: pointer; flex-shrink: 0; }
        .task-card .star svg { width: 16px; height: 16px; fill: var(--neu-dark); transition: 0.2s; }
        .task-card .star.active svg { fill: var(--theme-color); }
        .task-card .task-time { font-size: 9px; color: var(--text-muted); flex-shrink: 0; font-weight: 600; }
        .task-card .task-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
        .task-card .check { cursor: pointer; flex-shrink: 0; }
        .task-card .check svg { width: 18px; height: 18px; color: var(--neu-dark); transition: 0.2s; }
        .task-card .check.active svg { color: var(--theme-color); }
        .task-card .drag-handle { cursor: grab; color: var(--neu-dark); font-size: 10px; padding: 0 4px; flex-shrink: 0; }
        .task-card.dragging { opacity: 0.5; box-shadow: var(--neu-inset-sm); }
        .category-filter { display: none; padding: 8px 10px; gap: 8px; flex-wrap: wrap; border-bottom: 1px solid rgba(163,177,198,0.25); background: var(--neu-bg); }
        .category-filter.show { display: flex; }
        .cat-tag { font-size: 9px; padding: 6px 12px; border-radius: 12px; background: var(--neu-bg); cursor: pointer; box-shadow: var(--neu-shadow-xs); color: var(--text-secondary); transition: all 0.2s ease; font-weight: 600; }
        .cat-tag:hover { box-shadow: 2px 2px 4px rgba(163,177,198,0.5), -2px -2px 4px rgba(255,255,255,0.5); }
        .cat-tag.active { box-shadow: var(--neu-inset); color: var(--text-primary); }

        /* Timeline Widget Styles - Neumorphism design */
        .timeline-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--neu-bg); border-radius: 16px; position: relative; }
        .timeline-scroll { flex: 1; overflow-y: auto; position: relative; padding-top: 24px; }
        .timeline-grid { position: relative; min-height: 100%; }
        .timeline-hour { display: flex; align-items: flex-start; height: 40px; border-bottom: 1px solid rgba(163,177,198,0.15); }
        .timeline-hour-label { width: 20px; font-size: 7px; color: var(--text-secondary); text-align: right; padding-right: 4px; flex-shrink: 0; padding-top: 1px; font-weight: 500; }
        .timeline-hour-content { flex: 1; position: relative; height: 100%; }
        .timeline-task { position: absolute; left: 2px; right: 2px; border-radius: 6px; padding: 1px 4px; font-size: 6px; overflow: hidden; z-index: 1; border-left: 2px solid var(--dark-theme-color); box-shadow: 2px 2px 4px rgba(163,177,198,0.3); }
        .timeline-task.solid { background: var(--theme-color); opacity: 0.75; }
        .timeline-task.gradient { background: linear-gradient(to bottom, var(--theme-color), transparent); opacity: 0.6; }
        .timeline-task .task-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--header-text-color); opacity: 0; transition: opacity 0.2s; font-size: 7px; }
        .timeline-task:hover .task-name { opacity: 1; }
        .timeline-task:hover { opacity: 0.95; box-shadow: 3px 3px 6px rgba(163,177,198,0.4); }
        .timeline-now-line { position: absolute; left: 20px; right: 0; height: 2px; background: var(--dark-theme-color); z-index: 10; border-radius: 1px; }
        .timeline-now-indicator { position: absolute; left: 14px; z-index: 11; }
        .timeline-date-label { position: absolute; top: 6px; left: 6px; right: 6px; font-size: 8px; color: var(--text-secondary); font-weight: 600; z-index: 15; background: var(--neu-bg); padding: 3px 0; text-align: center; border-radius: 8px; }

        /* Horizontal Timeline - Neumorphism */
        .timeline-horizontal { flex: 1; display: flex; flex-direction: column; background: var(--neu-bg); position: relative; padding-top: 28px; }
        .timeline-h-scroll { flex: 1; overflow-x: auto; padding: 6px 10px; }
        .timeline-h-grid { display: flex; height: 100%; min-width: max-content; position: relative; }
        .timeline-h-hour { width: 90px; height: 100%; border-left: 1px solid rgba(163,177,198,0.2); position: relative; flex-shrink: 0; }
        .timeline-h-hour-label { position: absolute; top: 4px; left: 6px; font-size: 9px; color: var(--text-secondary); font-weight: 500; }
        .timeline-h-task { position: absolute; top: 26px; height: 22px; background: var(--theme-color); border-radius: 8px; padding: 3px 8px; font-size: 9px; color: transparent; overflow: hidden; transition: all 0.2s; opacity: 0.8; border-top: 2px solid var(--dark-theme-color); box-shadow: 2px 2px 4px rgba(163,177,198,0.3); }
        .timeline-h-task:hover { color: var(--header-text-color); opacity: 0.95; box-shadow: 3px 3px 6px rgba(163,177,198,0.4); }
        .timeline-h-now { position: absolute; top: 18px; bottom: 0; width: 2px; background: var(--dark-theme-color); z-index: 10; border-radius: 1px; }
        .timeline-h-now-indicator { position: absolute; top: 12px; z-index: 11; }
        .timeline-h-date { position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--text-secondary); font-weight: 600; z-index: 5; }

        /* Circle Timeline - Neumorphism */
        .timeline-circle { flex: 1; display: flex; align-items: center; justify-content: center; background: var(--neu-bg); position: relative; padding: 10px; }
        .timeline-circle .circle-date { position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 9px; color: var(--text-secondary); font-weight: 600; cursor: pointer; }

        /* All-day events popup */
        .allday-popup { position: absolute; background: var(--neu-bg); border-radius: 14px; box-shadow: var(--neu-shadow); padding: 12px; z-index: 100; min-width: 130px; max-width: 170px; max-height: 160px; overflow-y: auto; display: none; }
        .allday-popup.show { display: block; }
        .allday-popup-title { font-size: 10px; font-weight: 700; color: var(--text-primary); margin-bottom: 6px; border-bottom: 1px solid rgba(163,177,198,0.3); padding-bottom: 6px; }
        .allday-popup-item { font-size: 9px; color: var(--text-secondary); padding: 4px 0; display: flex; align-items: center; gap: 6px; }
        .allday-popup-item .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--theme-color); flex-shrink: 0; box-shadow: 1px 1px 2px rgba(163,177,198,0.3); }

        /* Calendar Widget Styles */
        .calendar-container { flex: 1; display: flex; flex-direction: column; padding: 10px; position: relative; background: var(--neu-bg); }
        .calendar-header { display: flex; align-items: center; justify-content: center; margin-bottom: 6px; gap: 10px; }
        .calendar-nav-btn { background: var(--neu-bg); border: none; cursor: pointer; font-size: 14px; color: var(--text-secondary); padding: 4px 8px; border-radius: 8px; box-shadow: var(--neu-shadow-sm); transition: all 0.2s ease; }
        .calendar-nav-btn:hover { box-shadow: var(--neu-inset-sm); }
        .calendar-month { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .calendar-year { font-size: 10px; color: var(--text-secondary); text-align: center; margin-bottom: 8px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
        .calendar-day-label { font-size: 7px; color: var(--text-secondary); text-align: center; font-weight: 600; padding: 3px 0; }
        .calendar-dates { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-date { font-size: 10px; text-align: center; padding: 4px 2px; border-radius: 8px; cursor: pointer; position: relative; color: var(--text-secondary); transition: all 0.2s ease; }
        .calendar-date:hover { background: rgba(163,177,198,0.2); box-shadow: var(--neu-inset-sm); }
        .calendar-date.other-month { color: var(--neu-dark); opacity: 0.5; }
        .calendar-date.today { font-weight: 700; color: var(--header-text-color); background: var(--theme-color); box-shadow: var(--neu-shadow-sm); }
        .calendar-date.has-event::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--dark-theme-color); border-radius: 50%; }
        .calendar-date.today.has-event::after { background: var(--header-text-color); }
        .calendar-date.has-priority { background: rgba(163,177,198,0.25); box-shadow: var(--neu-inset-sm); }
        .calendar-date.today.has-priority { background: var(--theme-color); }

        /* Calendar Popup - click to show, constrained within widget */
        .calendar-popup { position: absolute; background: var(--neu-bg); border-radius: 14px; box-shadow: var(--neu-shadow); padding: 12px; z-index: 100; min-width: 130px; max-width: 180px; max-height: 190px; overflow-y: auto; display: none; }
        .calendar-popup.show { display: block; }
        .calendar-popup-title { font-size: 10px; font-weight: 700; color: var(--text-primary); margin-bottom: 6px; border-bottom: 1px solid rgba(163,177,198,0.3); padding-bottom: 6px; }
        .calendar-popup-item { font-size: 9px; color: var(--text-secondary); padding: 5px 0; display: flex; align-items: center; gap: 6px; }
        .calendar-popup-item .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--dark-theme-color); flex-shrink: 0; box-shadow: 1px 1px 2px rgba(163,177,198,0.3); }
        .calendar-popup-item .star-mini { cursor: pointer; flex-shrink: 0; }
        .calendar-popup-item .star-mini svg { width: 12px; height: 12px; fill: var(--neu-dark); transition: 0.2s; }
        .calendar-popup-item .star-mini.active svg { fill: var(--dark-theme-color); }
        .calendar-popup-item .item-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Context Menu */
        .context-menu { position: fixed; background: var(--neu-bg); border-radius: 16px; box-shadow: var(--neu-shadow); z-index: 1000; display: none; min-width: 140px; overflow: hidden; }
        .context-menu.show { display: block; }
        .context-menu-item { padding: 12px 16px; font-size: 13px; cursor: pointer; color: var(--text-primary); transition: all 0.2s ease; font-weight: 500; }
        .context-menu-item:hover { background: rgba(163,177,198,0.15); }
        .context-menu-item.danger { color: #e57373; }
        .context-menu-divider { height: 1px; background: rgba(163,177,198,0.25); margin: 4px 0; }

        /* Toast */
        #toast { position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: var(--neu-bg); padding: 14px 28px; border-radius: 16px; font-size: 14px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; box-shadow: var(--neu-shadow); font-weight: 600; }
        #toast.show { bottom: 40px; }

        body.is-embed .main-layout { display: none; }
        body.is-embed { padding: 0; min-height: auto; background: var(--neu-bg); }
        body.is-embed .widget-frame { margin: 0; }
    </style>
</head>
<body>

    <div class="main-layout" id="mainLayout">
        <div class="window" id="setupWindow">
            <div class="title-bar">
                <div class="dots"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div>
                <div class="bar-title">Life Cooker</div>
                <div class="nav-controls">
                    <button class="nav-btn" id="prevBtn" onclick="moveStep(-1)" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <button class="nav-btn" id="nextBtn" onclick="moveStep(1)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="step active" id="step1">
                    <h1>Customize</h1>
                    <p>Set your widget theme and options.</p>

                    <label class="label-text">Background Color</label>
                    <div class="color-palette" id="bgPalette"></div>
                    <input type="color" id="bgCp" style="visibility:hidden;width:0;height:0;" oninput="updateBgColor(this.value)">
                    <button class="nav-btn" style="width:100%;padding:12px;margin-bottom:16px;border-radius:12px;font-size:12px;font-weight:600;color:var(--text-muted);" onclick="document.getElementById('bgCp').click()">Custom Color</button>

                    <label class="label-text">Text & Icon Color</label>
                    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;">
                        <div class="color-palette" id="textPalette" style="flex:1;margin-bottom:0;"></div>
                        <button class="nav-btn" id="autoTextBtn" style="padding:8px 14px;border-radius:10px;font-size:11px;font-weight:600;" onclick="setAutoTextColor()">Auto</button>
                    </div>

                    <label class="label-text">Widget Color</label>
                    <div class="color-palette" id="palette"></div>
                    <input type="color" id="cp" style="visibility:hidden;width:0;height:0;" oninput="updateTheme(this.value)">
                    <button class="nav-btn" style="width:100%;padding:12px;margin-bottom:16px;border-radius:12px;font-size:12px;font-weight:600;color:var(--text-muted);" onclick="document.getElementById('cp').click()">Custom Color</button>

                    <div class="option-group">
                        <label>Completed Tasks</label>
                        <div class="option-row">
                            <button class="option-btn active" data-done="bottom" onclick="setDoneStyle('bottom')">Move to Bottom</button>
                            <button class="option-btn" data-done="gray" onclick="setDoneStyle('gray')">Gray Out</button>
                        </div>
                    </div>

                    <div class="option-group">
                        <label>Week Starts On</label>
                        <div class="option-row">
                            <button class="option-btn active" data-weekstart="sun" onclick="setWeekStart('sun')">Sunday</button>
                            <button class="option-btn" data-weekstart="mon" onclick="setWeekStart('mon')">Monday</button>
                        </div>
                    </div>

                    <div class="option-group">
                        <label>Timeline Style</label>
                        <div class="option-row">
                            <button class="option-btn active" data-shape="vertical" onclick="setTimelineShape('vertical')">Vertical</button>
                            <button class="option-btn" data-shape="horizontal" onclick="setTimelineShape('horizontal')">Horizontal</button>
                            <button class="option-btn" data-shape="circle" onclick="setTimelineShape('circle')">Circle</button>
                        </div>
                        <div class="time-range-group" id="timeRangeGroup">
                            <select id="timeStart" onchange="setTimeRange()">
                                <option value="0">0:00</option>
                                <option value="5">5:00</option>
                                <option value="6" selected>6:00</option>
                                <option value="7">7:00</option>
                                <option value="8">8:00</option>
                                <option value="9">9:00</option>
                            </select>
                            <span style="font-size:11px;color:var(--text-muted);">~</span>
                            <select id="timeEnd" onchange="setTimeRange()">
                                <option value="18">18:00</option>
                                <option value="20">20:00</option>
                                <option value="22">22:00</option>
                                <option value="23" selected>23:00</option>
                                <option value="24">24:00</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="step" id="step2">
                    <h1>Connect Notion</h1>
                    <p>Enter your Internal Integration token to load databases.</p>

                    <label class="label-text" style="display:flex;align-items:center;gap:8px;">
                        Notion API Token
                        <span id="connectionIndicator" style="width:8px;height:8px;border-radius:50%;background:#ccc;box-shadow:0 0 0 2px rgba(0,0,0,0.1);transition:all 0.3s;"></span>
                    </label>
                    <input type="password" id="tokenInput" placeholder="ntn_..." style="margin-bottom:8px;">
                    <div style="margin-bottom:16px;"><a href="https://www.notion.so/my-integrations" target="_blank" style="font-size:11px;color:var(--text-muted);text-decoration:none;">Go to My Integrations ↗</a></div>

                    <div id="notionConnectArea">
                        <button class="nav-btn" style="width:100%;padding:14px;border-radius:12px;font-size:13px;font-weight:600;" onclick="loadDatabases()">Load Databases</button>
                    </div>

                    <div id="notionConnectedArea" style="display:none;">
                        <label class="label-text">Database</label>
                        <select id="dbSelect"></select>
                    </div>
                </div>

                <div class="step" id="step3">
                    <h1>Embed Widgets</h1>
                    <p>Paste the URLs below into Notion <strong>/embed</strong> blocks.</p>

                    <div class="url-box">
                        <label>1. Setup Widget</label>
                        <div class="url-text" id="setupUrl">-</div>
                        <button class="copy-btn" onclick="copyUrl('setup')">Copy Link</button>
                    </div>

                    <div class="url-box">
                        <label>2. Todo Widget</label>
                        <div class="url-text" id="todoUrl">-</div>
                        <button class="copy-btn" onclick="copyUrl('todo')">Copy Link</button>
                    </div>

                    <div class="url-box">
                        <label>3. Timeline Widget</label>
                        <div class="url-text" id="timelineUrl">-</div>
                        <button class="copy-btn" onclick="copyUrl('timeline')">Copy Link</button>
                    </div>

                    <div class="url-box">
                        <label>4. Calendar Widget</label>
                        <div class="url-text" id="calendarUrl">-</div>
                        <button class="copy-btn" onclick="copyUrl('calendar')">Copy Link</button>
                    </div>

                    <div style="padding: 14px; border-radius: 14px; background: #E8ECEF; box-shadow: inset 2px 2px 4px rgba(174,184,194,0.35), inset -2px -2px 4px rgba(255,255,255,0.55); margin-top: 8px;">
                        <div style="font-size: 12px; color: #6b7a8d; line-height: 1.7;">
                            <strong style="color: #3a4556;">How to embed:</strong><br>
                            1. Open your Notion page<br>
                            2. Type <code style="padding: 2px 6px; border-radius: 4px; background: #E8ECEF; box-shadow: inset 2px 2px 4px rgba(174,184,194,0.35), inset -2px -2px 4px rgba(255,255,255,0.55); font-size: 11px;">/embed</code> and press Enter<br>
                            3. Paste URL and click "Embed link"
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="previewSection">
            <div class="preview-title">Widget Preview</div>
            <div class="preview-widgets" id="widgetPreviews">
                <!-- Row 1: Setup & Todo -->
                <div class="preview-row">
                    <div class="widget-frame" id="previewSetup">
                        <div class="widget-top"><div class="w-dots"><div class="w-dot"></div><div class="w-dot"></div><div class="w-dot"></div></div><div class="w-title">Setup</div></div>
                        <div class="widget-home">
                            <div class="current-time">00:00</div>
                            <div class="current-date">SUN, FEB 1</div>
                            <div class="action-btns">
                                <button class="action-btn">+ Task</button>
                                <button class="action-btn">+ Routine</button>
                            </div>
                        </div>
                    </div>

                    <div class="widget-frame calendar-widget" id="previewCalendar">
                        <div class="widget-top"><div class="w-dots"><div class="w-dot"></div><div class="w-dot"></div><div class="w-dot"></div></div><div class="w-title">Calendar</div></div>
                        <div class="calendar-container" id="previewCalendarContainer"></div>
                    </div>
                </div>

                <!-- Row 2: Timeline Types -->
                <div class="preview-row">
                    <div>
                        <div class="widget-frame timeline-widget" id="previewTimelineV" style="width:80px !important;height:280px !important;">
                            <div class="timeline-container">
                                <div class="timeline-scroll">
                                    <div class="timeline-grid" id="previewGridV"></div>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-preview-label">Vertical</div>
                    </div>

                    <div>
                        <div class="widget-frame" id="previewTimelineC" style="width:120px !important;height:140px !important;">
                            <div class="timeline-circle" id="previewCircleContainer">
                                <canvas id="previewCircleCanvas" width="100" height="100"></canvas>
                                <div class="circle-date" style="bottom:8px;font-size:8px;">Feb 8</div>
                            </div>
                        </div>
                        <div class="timeline-preview-label">Circle</div>
                    </div>

                    <div>
                        <div class="widget-frame todo-widget" id="previewTodo" style="width:180px !important;height:160px !important;">
                            <div class="widget-top"><div class="w-dots"><div class="w-dot"></div><div class="w-dot"></div><div class="w-dot"></div></div><div class="w-title">Todo</div></div>
                            <div class="widget-home">
                                <div class="current-time" style="font-size:28px;">00:00</div>
                                <div class="current-date">SUN, FEB 1</div>
                                <button class="action-btn" style="font-size:9px;padding:6px 12px;">View Tasks</button>
                            </div>
                        </div>
                        <div class="timeline-preview-label">Todo</div>
                    </div>
                </div>

                <!-- Row 3: Horizontal Timeline -->
                <div class="preview-row" style="width:100%;">
                    <div style="width:100%;">
                        <div class="widget-frame timeline-widget horizontal" id="previewTimelineH" style="width:100% !important;max-width:480px !important;height:100px !important;">
                            <div class="timeline-horizontal" id="previewHContainer">
                                <div class="timeline-h-scroll">
                                    <div class="timeline-h-grid" id="previewGridH"></div>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-preview-label">Horizontal Timeline</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Embed Widget -->
    <div class="widget-frame" id="embedWidget" style="display:none;">
        <div class="widget-top" id="widgetTopBar">
            <div class="w-dots"><div class="w-dot"></div><div class="w-dot"></div><div class="w-dot"></div></div>
            <div class="w-title" id="widgetTitle" onclick="toggleCategoryFilter()">Widget</div>
            <button class="header-refresh-btn" id="headerRefreshBtn" onclick="refreshTasksWithSpin()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            </button>
        </div>

        <!-- Setup Widget (for adding tasks) -->
        <div id="setupWidget" style="display:none;">
            <div class="widget-home" id="setupHome">
                <div class="current-time" id="setupTime">00:00</div>
                <div class="current-date" id="setupDate">SUN, FEB 1</div>
                <div class="action-btns">
                    <button class="action-btn" onclick="showSetupForm('task')">+ Task</button>
                    <button class="action-btn" onclick="showSetupForm('routine')">+ Routine</button>
                </div>
            </div>
            <div class="setup-form" id="setupForm" style="display:none;">
                <div class="setup-form-header">
                    <button class="back-btn" onclick="hideSetupForm()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <div class="form-type-btns">
                        <button class="form-type-btn active" id="btnTask" onclick="setFormType('task')">Task</button>
                        <button class="form-type-btn" id="btnRoutine" onclick="setFormType('routine')">Routine</button>
                    </div>
                </div>
                <input type="text" class="mini-input" id="taskTitle" placeholder="Enter task..." onkeydown="handleEnterKey(event)">
                <input type="date" class="mini-input" id="taskDate">
                <label class="form-check">
                    <input type="checkbox" id="allDayCheck" onchange="toggleAllDay()">
                    <span>All day</span>
                </label>
                <div id="timeInputs">
                    <div class="form-row">
                        <span class="form-label">Start</span>
                        <input type="time" class="mini-input" id="taskStartTime">
                    </div>
                    <div class="form-row">
                        <span class="form-label">End</span>
                        <input type="time" class="mini-input" id="taskEndTime">
                    </div>
                </div>
                <div id="routineOptions" style="display:none;">
                    <div class="form-label" style="margin-bottom:4px;">Repeat Days</div>
                    <div class="repeat-row">
                        <div class="repeat-day" data-day="0" onclick="toggleRepeatDay(0)">Su</div>
                        <div class="repeat-day" data-day="1" onclick="toggleRepeatDay(1)">Mo</div>
                        <div class="repeat-day" data-day="2" onclick="toggleRepeatDay(2)">Tu</div>
                        <div class="repeat-day" data-day="3" onclick="toggleRepeatDay(3)">We</div>
                        <div class="repeat-day" data-day="4" onclick="toggleRepeatDay(4)">Th</div>
                        <div class="repeat-day" data-day="5" onclick="toggleRepeatDay(5)">Fr</div>
                        <div class="repeat-day" data-day="6" onclick="toggleRepeatDay(6)">Sa</div>
                    </div>
                </div>
                <div class="form-row" style="align-items:stretch;">
                    <select class="mini-select" id="taskCategory" style="flex:1;margin-bottom:0;">
                        <option value="">Select category</option>
                    </select>
                    <button type="button" class="mini-cat-btn" onclick="editSelectedCategory()" title="Rename">✎</button>
                    <button type="button" class="mini-cat-btn danger" onclick="deleteSelectedCategory()" title="Delete">×</button>
                </div>
                <input type="text" class="mini-input" id="newCategory" placeholder="New category...">
                <div class="btn-row">
                    <button class="btn-cancel" onclick="hideSetupForm()">Cancel</button>
                    <button class="btn-save" onclick="saveTask()">Save</button>
                </div>
            </div>
        </div>

        <!-- Todo Widget (for viewing/editing tasks) -->
        <div id="todoWidget" style="display:none;">
            <button class="refresh-btn" id="todoRefreshBtn" onclick="refreshTasksWithSpin()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            </button>
            <div class="category-filter" id="categoryFilter"></div>
            <div class="todo-header">
                <button class="todo-tab active" id="tabTasks" onclick="setTodoTab('tasks')">Tasks</button>
                <button class="todo-tab" id="tabRoutines" onclick="setTodoTab('routines')">Routines</button>
            </div>
            <div class="todo-container" id="todoContainer"></div>
        </div>

        <!-- Timeline Widget -->
        <div id="timelineWidget" style="display:none;">
            <button class="refresh-btn" id="timelineRefreshBtn" onclick="refreshTasksWithSpin()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            </button>
            <div class="timeline-container" id="timelineContainer"></div>
            <div class="allday-popup" id="allDayPopup"></div>
        </div>

        <!-- Calendar Widget -->
        <div id="calendarWidget" style="display:none;">
            <button class="refresh-btn" id="calendarRefreshBtn" onclick="refreshTasksWithSpin()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            </button>
            <div class="calendar-container" id="calendarContainer"></div>
            <div class="calendar-popup" id="calendarPopup"></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="postponeTask()">Postpone to Tomorrow</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="deleteTask()">Delete</div>
    </div>

    <div id="toast">Saved!</div>

<script>
    const SERVER_URL = "https://calendar-server-hrgs.onrender.com";
    // Neumorphism-friendly soft pastel colors
    const bgThemes = ["E8ECEF", "F5F0EB", "EBF0E8", "E8EBF0", "F0E8EB", "E8F0EF"];
    const textThemes = ["3a4556", "5a6a7a", "8895a7"];
    const themes = ["d4a5a5", "e8d5a3", "a8c5a0", "9fb8c7", "c4b8d4", "8fa5a0"];
    let step = 1;
    let selectedBgColor = "E8ECEF";
    let selectedTextColor = "3a4556";
    let isAutoText = true;
    let selectedColor = "a8c5a0";
    let doneStyle = "bottom";
    let weekStart = "sun";
    let timelineShape = "vertical";
    let timeStart = 6;
    let timeEnd = 23;
    let categories = [];
    let tasks = [];
    let selectedTaskId = null;
    let showCategoryFilter = false;
    let selectedCategory = null;
    let calendarDate = new Date();
    let formType = 'task';
    let repeatDays = [];
    let draggedItem = null;
    let todoTab = 'tasks';
    let selectedDateStr = null;

    const params = new URLSearchParams(window.location.search);
    const widgetType = params.get('w');

    function getLocalDate() {
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    // Format time for Notion - keep as local time string (GMT+0 style)
    function formatDateTimeForNotion(date, time) {
        if (!time) return date; // date only
        // Return as simple datetime string without timezone conversion
        return `${date}T${time}:00.000+00:00`;
    }

    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
        const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        document.querySelectorAll('.current-time').forEach(el => el.innerText = timeStr);
        document.querySelectorAll('.current-date').forEach(el => el.innerText = dateStr);
    }
    setInterval(updateClock, 1000);
    updateClock();

    function renderPreviewTimeline() {
        // Vertical timeline
        const gridV = document.getElementById('previewGridV');
        if (gridV) {
            let html = '';
            for (let h = 8; h <= 18; h++) {
                html += `<div class="timeline-hour"><div class="timeline-hour-label">${h}</div><div class="timeline-hour-content"></div></div>`;
            }
            gridV.innerHTML = html;
        }

        // Horizontal timeline
        const gridH = document.getElementById('previewGridH');
        if (gridH) {
            let html = '';
            for (let h = 8; h <= 20; h++) {
                html += `<div class="timeline-h-hour"><div class="timeline-h-hour-label">${h}:00</div></div>`;
            }
            gridH.innerHTML = html;
        }

        // Circle timeline
        const canvas = document.getElementById('previewCircleCanvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            const size = 100;
            const cx = size / 2, cy = size / 2, radius = 38;
            ctx.clearRect(0, 0, size, size);

            // Background circle
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(163,177,198,0.3)';
            ctx.lineWidth = 6;
            ctx.stroke();

            // Progress arc (theme color)
            const now = new Date();
            const progress = (now.getHours() * 60 + now.getMinutes()) / (24 * 60);
            ctx.beginPath();
            ctx.arc(cx, cy, radius, -Math.PI / 2, -Math.PI / 2 + progress * Math.PI * 2);
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim() || '#a8c5a0';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.stroke();

            // Center time
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || '#3a4556';
            ctx.font = 'bold 14px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }), cx, cy);
        }
    }
    renderPreviewTimeline();
    setInterval(renderPreviewTimeline, 60000); // Update circle every minute

    function renderPreviewCalendar() {
        const container = document.getElementById('previewCalendarContainer');
        if (!container) return;
        renderCalendarContent(container, new Date(), weekStart, [], false);
    }
    renderPreviewCalendar();

    function updateHeaderTextColor(hex) {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        const textColor = brightness < 128 ? '#ffffff' : '#1d1d1f';
        document.documentElement.style.setProperty('--header-text-color', textColor);
    }

    // Initialize
    if (params.get('t') && widgetType) {
        document.body.classList.add('is-embed');
        document.getElementById('embedWidget').style.display = 'flex';

        if (widgetType === 'timeline') {
            const shape = params.get('ts') || 'vertical';
            if (shape === 'horizontal') {
                document.getElementById('embedWidget').classList.add('timeline-widget', 'horizontal');
            } else if (shape === 'circle') {
                document.getElementById('embedWidget').classList.add('calendar-widget');
            } else {
                document.getElementById('embedWidget').classList.add('timeline-widget');
            }
            document.getElementById('widgetTopBar').classList.add('hidden');
        } else if (widgetType === 'calendar') {
            document.getElementById('embedWidget').classList.add('calendar-widget');
            document.getElementById('widgetTopBar').classList.add('hidden');
        } else if (widgetType === 'todo') {
            document.getElementById('embedWidget').classList.add('todo-widget');
        }

        const c = params.get('c');
        if (c) updateTheme('#' + c);

        doneStyle = params.get('ds') || 'bottom';
        weekStart = params.get('ws') || 'sun';
        timelineShape = params.get('ts') || 'vertical';
        timeStart = parseInt(params.get('th1')) || 6;
        timeEnd = parseInt(params.get('th2')) || 23;
        const bg = params.get('bg');
        if (bg) updateBgColor('#' + bg);
        const tc = params.get('tc');
        if (tc) {
            isAutoText = false;
            applyTextColor(tc);
        }
        initWidget(widgetType);
    } else {
        // Background color palette
        const bgPal = document.getElementById('bgPalette');
        bgThemes.forEach(t => {
            const d = document.createElement('div');
            d.className = 'color-dot' + (t === 'E8ECEF' ? ' active' : '');
            d.style.background = '#' + t;
            d.onclick = () => {
                bgPal.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
                d.classList.add('active');
                updateBgColor('#' + t);
            };
            bgPal.appendChild(d);
        });

        // Text color palette
        const textPal = document.getElementById('textPalette');
        textThemes.forEach(t => {
            const d = document.createElement('div');
            d.className = 'color-dot';
            d.style.background = '#' + t;
            d.onclick = () => {
                textPal.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
                d.classList.add('active');
                setTextColor(t);
            };
            textPal.appendChild(d);
        });
        document.getElementById('autoTextBtn').classList.add('active');

        // Widget color palette
        const pal = document.getElementById('palette');
        themes.forEach(t => {
            const d = document.createElement('div');
            d.className = 'color-dot' + (t === 'a8c5a0' ? ' active' : '');
            d.style.background = '#' + t;
            d.onclick = () => {
                pal.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
                d.classList.add('active');
                updateTheme('#' + t);
            };
            pal.appendChild(d);
        });
        updateBgColor('#E8ECEF');
        updateTheme('#a8c5a0');
    }

    function updateBgColor(hex) {
        selectedBgColor = hex.replace('#', '');
        const r = parseInt(selectedBgColor.slice(0,2), 16);
        const g = parseInt(selectedBgColor.slice(2,4), 16);
        const b = parseInt(selectedBgColor.slice(4,6), 16);

        // Calculate luminance to determine if bg is light or dark
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

        // Stronger neumorphism shadow calculation for more pronounced 3D effect
        // Light shadow: blend towards white
        const lightFactor = luminance > 0.5 ? 0.6 : 0.25;
        const lightR = Math.min(255, Math.round(r + (255 - r) * lightFactor));
        const lightG = Math.min(255, Math.round(g + (255 - g) * lightFactor));
        const lightB = Math.min(255, Math.round(b + (255 - b) * lightFactor));

        // Dark shadow: stronger contrast
        const darkFactor = luminance > 0.5 ? 0.75 : 0.55;
        const darkR = Math.max(0, Math.round(r * darkFactor));
        const darkG = Math.max(0, Math.round(g * darkFactor));
        const darkB = Math.max(0, Math.round(b * darkFactor));

        // Higher opacity for more visible shadows
        const darkOpacity = luminance > 0.5 ? 0.5 : 0.6;
        const lightOpacity = luminance > 0.5 ? 0.7 : 0.25;

        document.documentElement.style.setProperty('--neu-bg', hex);
        document.documentElement.style.setProperty('--neu-light', `rgb(${lightR},${lightG},${lightB})`);
        document.documentElement.style.setProperty('--neu-dark', `rgb(${darkR},${darkG},${darkB})`);

        // Update shadow CSS variables - stronger values for 3D effect
        document.documentElement.style.setProperty('--neu-shadow',
            `8px 8px 16px rgba(${darkR},${darkG},${darkB},${darkOpacity}), -8px -8px 16px rgba(${lightR},${lightG},${lightB},${lightOpacity})`);
        document.documentElement.style.setProperty('--neu-shadow-sm',
            `5px 5px 10px rgba(${darkR},${darkG},${darkB},${darkOpacity * 0.85}), -5px -5px 10px rgba(${lightR},${lightG},${lightB},${lightOpacity * 0.85})`);
        document.documentElement.style.setProperty('--neu-shadow-xs',
            `3px 3px 6px rgba(${darkR},${darkG},${darkB},${darkOpacity * 0.7}), -3px -3px 6px rgba(${lightR},${lightG},${lightB},${lightOpacity * 0.7})`);
        document.documentElement.style.setProperty('--neu-inset',
            `inset 4px 4px 8px rgba(${darkR},${darkG},${darkB},${darkOpacity * 0.8}), inset -4px -4px 8px rgba(${lightR},${lightG},${lightB},${lightOpacity * 0.8})`);
        document.documentElement.style.setProperty('--neu-inset-sm',
            `inset 2px 2px 4px rgba(${darkR},${darkG},${darkB},${darkOpacity * 0.7}), inset -2px -2px 4px rgba(${lightR},${lightG},${lightB},${lightOpacity * 0.7})`);

        // Change page background
        document.body.style.background = hex;
        document.documentElement.style.background = hex;

        // Auto-update text color if enabled
        if (isAutoText) {
            autoCalculateTextColor(r, g, b, luminance);
        }
    }

    function autoCalculateTextColor(r, g, b, luminance) {
        // Calculate appropriate text color based on background
        let textColor;
        if (luminance > 0.6) {
            textColor = '3a4556'; // Dark text for light bg
        } else if (luminance > 0.4) {
            textColor = '4a5568'; // Medium text
        } else {
            textColor = 'e8ecef'; // Light text for dark bg
        }
        applyTextColor(textColor);

        // Update text palette selection
        const textPal = document.getElementById('textPalette');
        if (textPal) {
            textPal.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
        }
    }

    function applyTextColor(color) {
        selectedTextColor = color;
        const hex = '#' + color;
        document.documentElement.style.setProperty('--text-primary', hex);

        // Calculate secondary and muted colors
        const r = parseInt(color.slice(0,2), 16);
        const g = parseInt(color.slice(2,4), 16);
        const b = parseInt(color.slice(4,6), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

        if (luminance > 0.5) {
            // Light text - make secondary darker
            document.documentElement.style.setProperty('--text-secondary', `rgba(${r},${g},${b},0.7)`);
            document.documentElement.style.setProperty('--text-muted', `rgba(${r},${g},${b},0.5)`);
        } else {
            // Dark text - make secondary lighter
            const secR = Math.min(255, r + 50);
            const secG = Math.min(255, g + 50);
            const secB = Math.min(255, b + 50);
            const mutR = Math.min(255, r + 90);
            const mutG = Math.min(255, g + 90);
            const mutB = Math.min(255, b + 90);
            document.documentElement.style.setProperty('--text-secondary', `rgb(${secR},${secG},${secB})`);
            document.documentElement.style.setProperty('--text-muted', `rgb(${mutR},${mutG},${mutB})`);
        }
    }

    function setAutoTextColor() {
        isAutoText = true;
        document.getElementById('autoTextBtn').classList.add('active');
        const textPal = document.getElementById('textPalette');
        if (textPal) {
            textPal.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
        }
        // Recalculate based on current bg
        const r = parseInt(selectedBgColor.slice(0,2), 16);
        const g = parseInt(selectedBgColor.slice(2,4), 16);
        const b = parseInt(selectedBgColor.slice(4,6), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        autoCalculateTextColor(r, g, b, luminance);
    }

    function setTextColor(color) {
        isAutoText = false;
        document.getElementById('autoTextBtn').classList.remove('active');
        applyTextColor(color);
    }

    function updateTheme(hex) {
        selectedColor = hex.replace('#', '');
        document.documentElement.style.setProperty('--theme-color', hex);
        const r = parseInt(selectedColor.slice(0,2), 16);
        const g = parseInt(selectedColor.slice(2,4), 16);
        const b = parseInt(selectedColor.slice(4,6), 16);
        // Create a darker, more saturated version for neumorphism
        const darkR = Math.max(0, Math.round(r * 0.6));
        const darkG = Math.max(0, Math.round(g * 0.6));
        const darkB = Math.max(0, Math.round(b * 0.6));
        document.documentElement.style.setProperty('--dark-theme-color', `rgb(${darkR},${darkG},${darkB})`);
        updateHeaderTextColor(hex);
        renderPreviewCalendar();
        renderPreviewTimeline();
    }

    function setDoneStyle(style) {
        doneStyle = style;
        document.querySelectorAll('[data-done]').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-done="${style}"]`)?.classList.add('active');
    }

    function setWeekStart(start) {
        weekStart = start;
        document.querySelectorAll('[data-weekstart]').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-weekstart="${start}"]`)?.classList.add('active');
        renderPreviewCalendar();
    }

    function setTimelineShape(shape) {
        timelineShape = shape;
        document.querySelectorAll('[data-shape]').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-shape="${shape}"]`)?.classList.add('active');
        document.getElementById('timeRangeGroup').style.display = shape === 'circle' ? 'none' : 'flex';
    }

    function setTimeRange() {
        timeStart = parseInt(document.getElementById('timeStart').value);
        timeEnd = parseInt(document.getElementById('timeEnd').value);
    }

    let notionConnected = false;

    async function loadDatabases() {
        const tk = document.getElementById('tokenInput').value;
        if (!tk) { showToast('Please enter a token'); return; }
        const indicator = document.getElementById('connectionIndicator');
        try {
            const res = await fetch(`${SERVER_URL}/api/notion/databases`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: tk })
            });
            const dbs = await res.json();
            if (dbs.error) {
                indicator.style.background = '#e57373';
                indicator.style.boxShadow = '0 0 6px rgba(229,115,115,0.6)';
                showToast('Token error');
                return;
            }
            document.getElementById('dbSelect').innerHTML = dbs.map(d => `<option value="${d.id}">${d.title}</option>`).join('');
            document.getElementById('notionConnectArea').style.display = 'none';
            document.getElementById('notionConnectedArea').style.display = 'block';
            // Green indicator with glow
            indicator.style.background = '#4CAF50';
            indicator.style.boxShadow = '0 0 6px rgba(76,175,80,0.6)';
            notionConnected = true;
            showToast('Databases loaded!');
        } catch (e) {
            indicator.style.background = '#e57373';
            indicator.style.boxShadow = '0 0 6px rgba(229,115,115,0.6)';
            showToast('Connection failed');
        }
    }

    async function moveStep(n) {
        const newStep = step + n;
        if (n === 1 && step === 2 && !notionConnected) {
            showToast('Please click Load Databases first');
            return;
        }
        if (newStep === 3) generateUrls();
        if (newStep < 1 || newStep > 3) return;
        document.getElementById(`step${step}`).classList.remove('active');
        step = newStep;
        document.getElementById(`step${step}`).classList.add('active');
        document.getElementById('prevBtn').disabled = (step === 1);
        document.getElementById('nextBtn').style.visibility = (step === 3) ? 'hidden' : 'visible';
    }

    function generateUrls() {
        const t = encodeURIComponent(btoa(document.getElementById('tokenInput').value));
        const d = encodeURIComponent(btoa(document.getElementById('dbSelect').value));
        const base = `${window.location.origin}${window.location.pathname}`;
        const common = `t=${t}&d=${d}&c=${selectedColor}&bg=${selectedBgColor}&tc=${selectedTextColor}&ds=${doneStyle}&ws=${weekStart}&ts=${timelineShape}&th1=${timeStart}&th2=${timeEnd}`;

        document.getElementById('setupUrl').innerText = `${base}?w=setup&${common}`;
        document.getElementById('todoUrl').innerText = `${base}?w=todo&${common}`;
        document.getElementById('timelineUrl').innerText = `${base}?w=timeline&${common}`;
        document.getElementById('calendarUrl').innerText = `${base}?w=calendar&${common}`;
    }

    function copyUrl(type) {
        const urlText = document.getElementById(`${type}Url`).innerText;
        navigator.clipboard.writeText(urlText);
        showToast('URL copied!');
    }

    function initWidget(type) {
        const titles = { setup: 'Setup', todo: 'Todo', timeline: 'Timeline', calendar: 'Calendar' };
        document.getElementById('widgetTitle').innerText = titles[type] || 'Widget';

        if (type === 'setup') {
            document.getElementById('setupWidget').style.display = 'flex';
            document.getElementById('setupWidget').style.flexDirection = 'column';
            document.getElementById('setupWidget').style.flex = '1';
            document.getElementById('setupWidget').style.minHeight = '0';
            loadCategories();
        } else if (type === 'todo') {
            document.getElementById('todoWidget').style.display = 'flex';
            document.getElementById('todoWidget').style.flexDirection = 'column';
            document.getElementById('todoWidget').style.flex = '1';
            document.getElementById('todoWidget').style.minHeight = '0';
            loadCategories();
            refreshTasks();
        } else if (type === 'timeline') {
            document.getElementById('timelineWidget').style.display = 'flex';
            document.getElementById('timelineWidget').style.flex = '1';
            document.getElementById('timelineWidget').style.position = 'relative';
            refreshTasks();
            setInterval(refreshTasks, 60000);
        } else if (type === 'calendar') {
            document.getElementById('calendarWidget').style.display = 'flex';
            document.getElementById('calendarWidget').style.flex = '1';
            document.getElementById('calendarWidget').style.position = 'relative';
            refreshTasks();
        }
    }

    function showSetupForm(type) {
        formType = type;
        document.getElementById('setupHome').style.display = 'none';
        document.getElementById('setupForm').style.display = 'flex';
        document.getElementById('taskDate').value = getLocalDate();
        document.getElementById('btnTask').classList.toggle('active', type === 'task');
        document.getElementById('btnRoutine').classList.toggle('active', type === 'routine');
        document.getElementById('routineOptions').style.display = type === 'routine' ? 'block' : 'none';
        document.getElementById('allDayCheck').checked = false;
        document.getElementById('timeInputs').style.display = 'block';
        document.getElementById('taskTitle').focus();
    }

    function hideSetupForm() {
        document.getElementById('setupForm').style.display = 'none';
        document.getElementById('setupHome').style.display = 'flex';
        clearSetupForm();
    }

    function setFormType(type) {
        formType = type;
        document.getElementById('btnTask').classList.toggle('active', type === 'task');
        document.getElementById('btnRoutine').classList.toggle('active', type === 'routine');
        document.getElementById('routineOptions').style.display = type === 'routine' ? 'block' : 'none';
    }

    function toggleAllDay() {
        const isAllDay = document.getElementById('allDayCheck').checked;
        document.getElementById('timeInputs').style.display = isAllDay ? 'none' : 'block';
        if (isAllDay) {
            document.getElementById('taskStartTime').value = '';
            document.getElementById('taskEndTime').value = '';
        }
    }

    function toggleRepeatDay(day) {
        const el = document.querySelector(`[data-day="${day}"]`);
        if (repeatDays.includes(day)) {
            repeatDays = repeatDays.filter(d => d !== day);
            el.classList.remove('active');
        } else {
            repeatDays.push(day);
            el.classList.add('active');
        }
    }

    function clearSetupForm() {
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskStartTime').value = '';
        document.getElementById('taskEndTime').value = '';
        document.getElementById('taskCategory').value = '';
        document.getElementById('newCategory').value = '';
        document.getElementById('allDayCheck').checked = false;
        document.getElementById('timeInputs').style.display = 'block';
        repeatDays = [];
        document.querySelectorAll('.repeat-day').forEach(el => el.classList.remove('active'));
        selectedTaskId = null;
    }

    function handleEnterKey(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveTask();
        }
    }

    function getToken() {
        return atob(decodeURIComponent(params.get('t') || ''));
    }
    function getDbId() {
        return atob(decodeURIComponent(params.get('d') || ''));
    }

    async function loadCategories() {
        try {
            const res = await fetch(`${SERVER_URL}/api/notion/categories`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), dbId: getDbId() })
            });
            const data = await res.json();
            categories = data.categories || [];
            updateCategorySelect();
            updateCategoryFilter();
        } catch (e) {
            console.error('Failed to load categories', e);
        }
    }

    function updateCategorySelect() {
        const select = document.getElementById('taskCategory');
        if (!select) return;
        select.innerHTML = '<option value="">Select category</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function editSelectedCategory() {
        const select = document.getElementById('taskCategory');
        const oldName = select.value;
        if (!oldName) { showToast('Please select a category'); return; }

        const newName = prompt('New category name:', oldName);
        if (!newName || newName === oldName) return;

        try {
            const res = await fetch(`${SERVER_URL}/api/notion/rename-category`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), dbId: getDbId(), oldName, newName })
            });
            const result = await res.json();
            if (result.success) {
                showToast('Category renamed!');
                const idx = categories.indexOf(oldName);
                if (idx > -1) categories[idx] = newName;
                updateCategorySelect();
                select.value = newName;
            } else {
                showToast(result.error || 'Rename failed');
            }
        } catch (e) {
            showToast('Connection error');
        }
    }

    async function deleteSelectedCategory() {
        const select = document.getElementById('taskCategory');
        const catName = select.value;
        if (!catName) { showToast('Please select a category'); return; }

        if (!confirm(`Delete category "${catName}"?`)) return;

        try {
            const res = await fetch(`${SERVER_URL}/api/notion/delete-category`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), dbId: getDbId(), categoryName: catName })
            });
            const result = await res.json();
            if (result.success) {
                showToast('Category deleted!');
                categories = categories.filter(c => c !== catName);
                updateCategorySelect();
            } else {
                showToast(result.error || 'Delete failed');
            }
        } catch (e) {
            showToast('Connection error');
        }
    }

    function updateCategoryFilter() {
        const filter = document.getElementById('categoryFilter');
        if (!filter) return;
        filter.innerHTML = '<div class="cat-tag' + (!selectedCategory ? ' active' : '') + '" onclick="filterByCategory(null)">All</div>' +
            categories.map(c => `<div class="cat-tag${selectedCategory === c ? ' active' : ''}" onclick="filterByCategory('${c}')">${c}</div>`).join('');
    }

    function toggleCategoryFilter() {
        if (widgetType !== 'todo') return;
        showCategoryFilter = !showCategoryFilter;
        document.getElementById('categoryFilter').classList.toggle('show', showCategoryFilter);
    }

    function filterByCategory(cat) {
        selectedCategory = cat;
        updateCategoryFilter();
        renderTasks();
    }

    // Generate routine dates until end of month
    function getRoutineDates(startDate, repeatDays) {
        const dates = [];
        const start = new Date(startDate);
        const endOfMonth = new Date(start.getFullYear(), start.getMonth() + 1, 0);

        let current = new Date(start);
        while (current <= endOfMonth) {
            if (repeatDays.includes(current.getDay())) {
                dates.push(`${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`);
            }
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    async function saveTask() {
        const title = document.getElementById('taskTitle').value.trim();
        const date = document.getElementById('taskDate').value;
        const isAllDay = document.getElementById('allDayCheck').checked;
        const startTime = isAllDay ? null : document.getElementById('taskStartTime').value;
        const endTime = isAllDay ? null : document.getElementById('taskEndTime').value;
        let category = document.getElementById('taskCategory').value;
        const newCategory = document.getElementById('newCategory').value.trim();

        if (newCategory) category = newCategory;

        if (!title) { showToast('Please enter a task'); return; }
        if (!date) { showToast('Please select a date'); return; }

        // Format start/end datetime in GMT for Notion
        const startDateTime = startTime ? formatDateTimeForNotion(date, startTime) : null;
        const endDateTime = endTime ? formatDateTimeForNotion(date, endTime) : null;

        try {
            if (formType === 'routine' && repeatDays.length > 0) {
                // Create multiple entries for routine until end of month
                const routineDates = getRoutineDates(date, repeatDays);
                for (const routineDate of routineDates) {
                    const routineStart = startTime ? formatDateTimeForNotion(routineDate, startTime) : null;
                    const routineEnd = endTime ? formatDateTimeForNotion(routineDate, endTime) : null;

                    const body = {
                        token: getToken(),
                        dbId: getDbId(),
                        title,
                        date: routineDate,
                        startDateTime: routineStart,
                        endDateTime: routineEnd,
                        startTime: startTime || null,
                        endTime: endTime || null,
                        category: category || null,
                        isRoutine: true,
                        repeatDays: repeatDays,
                        isAllDay: isAllDay
                    };
                    await fetch(`${SERVER_URL}/api/notion/add-event`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                }
                showToast(`${routineDates.length} routines created!`);
            } else {
                const body = {
                    token: getToken(),
                    dbId: getDbId(),
                    title,
                    date,
                    startDateTime: startDateTime,
                    endDateTime: endDateTime,
                    startTime: startTime || null,
                    endTime: endTime || null,
                    category: category || null,
                    isRoutine: false,
                    isAllDay: isAllDay
                };
                const res = await fetch(`${SERVER_URL}/api/notion/add-event`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await res.json();
                if (res.ok && result.success) {
                    showToast('Saved!');
                } else {
                    showToast(result.error || 'Save failed');
                    return;
                }
            }
            hideSetupForm();
            if (newCategory && !categories.includes(newCategory)) {
                categories.push(newCategory);
                updateCategorySelect();
            }
        } catch (e) {
            showToast('Connection error');
        }
    }

    async function refreshTasksWithSpin() {
        const headerBtn = document.getElementById('headerRefreshBtn');
        if (headerBtn) headerBtn.classList.add('spinning');
        await refreshTasks();
        setTimeout(() => {
            if (headerBtn) headerBtn.classList.remove('spinning');
        }, 500);
    }

    async function refreshTasks() {
        try {
            const res = await fetch(`${SERVER_URL}/api/notion/events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), dbId: getDbId() })
            });
            tasks = await res.json();
            if (Array.isArray(tasks)) {
                if (widgetType === 'todo') renderTasks();
                else if (widgetType === 'timeline') renderTimeline();
                else if (widgetType === 'calendar') renderCalendar();
            }
        } catch (e) {
            console.error('Failed to load tasks', e);
        }
    }

    function setTodoTab(tab) {
        todoTab = tab;
        document.getElementById('tabTasks').classList.toggle('active', tab === 'tasks');
        document.getElementById('tabRoutines').classList.toggle('active', tab === 'routines');
        renderTasks();
    }

    function renderTasks() {
        const container = document.getElementById('todoContainer');
        if (!container) return;

        // Use YYYY-MM-DD format for consistent date comparison
        const todayStr = getLocalDate();
        let filtered = tasks.filter(t => {
            if (!t.date) return false;
            // Compare just the date part (YYYY-MM-DD)
            const taskDate = t.date.split('T')[0];
            return taskDate === todayStr;
        });

        if (selectedCategory) {
            filtered = filtered.filter(t => t.category === selectedCategory);
        }

        // Filter by tab
        if (todoTab === 'tasks') {
            filtered = filtered.filter(t => !t.isRoutine);
        } else {
            filtered = filtered.filter(t => t.isRoutine);
        }

        // Separate done and not done
        const notDone = filtered.filter(t => !t.done);
        const done = filtered.filter(t => t.done);

        // Sort by time
        notDone.sort((a, b) => (a.startTime || '99:99').localeCompare(b.startTime || '99:99'));

        let html = '';

        notDone.forEach(t => html += renderTaskCard(t));

        if (done.length > 0 && doneStyle === 'bottom') {
            html += '<div class="task-section-divider"></div>';
            done.forEach(t => html += renderTaskCard(t));
        }

        container.innerHTML = html || '<div style="text-align:center;color:#ccc;font-size:9px;padding:20px;">No items</div>';
    }

    function renderTaskCard(t) {
        const timeDisplay = t.startTime ? t.startTime.substring(0,5) : '';
        return `
        <div class="task-card ${t.done ? 'done' : ''}" data-id="${t.id}" oncontextmenu="showContextMenu(event, '${t.id}')">
            <span class="star ${t.priority ? 'active' : ''}" onclick="togglePriority('${t.id}')">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </span>
            ${timeDisplay ? `<span class="task-time">${timeDisplay}</span>` : ''}
            <span class="task-title">${t.title}</span>
            <span class="check ${t.done ? 'active' : ''}" onclick="toggleDone('${t.id}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
            </span>
        </div>`;
    }

    async function togglePriority(id) {
        try {
            await fetch(`${SERVER_URL}/api/notion/toggle-star`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), taskId: id })
            });
            refreshTasks();
        } catch (e) {
            showToast('Error occurred');
        }
    }

    async function toggleDone(id) {
        try {
            await fetch(`${SERVER_URL}/api/notion/complete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), taskId: id })
            });
            refreshTasks();
        } catch (e) {
            showToast('Error occurred');
        }
    }

    function showContextMenu(e, id) {
        e.preventDefault();
        selectedTaskId = id;
        const menu = document.getElementById('contextMenu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.add('show');
    }

    document.addEventListener('click', (e) => {
        document.getElementById('contextMenu').classList.remove('show');
        if (!e.target.closest('.calendar-popup') && !e.target.closest('.calendar-date')) {
            hideCalendarPopup();
        }
        if (!e.target.closest('.allday-popup') && !e.target.closest('.timeline-date-label') && !e.target.closest('.timeline-h-date') && !e.target.closest('.circle-date')) {
            hideAllDayPopup();
        }
    });

    async function postponeTask() {
        if (!selectedTaskId) return;
        try {
            await fetch(`${SERVER_URL}/api/notion/postpone`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), taskId: selectedTaskId })
            });
            showToast('Postponed to tomorrow!');
            refreshTasks();
        } catch (e) {
            showToast('Postpone failed');
        }
        selectedTaskId = null;
    }

    async function deleteTask() {
        if (!selectedTaskId) return;
        try {
            await fetch(`${SERVER_URL}/api/notion/delete-event`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: getToken(), taskId: selectedTaskId })
            });
            showToast('Deleted!');
            refreshTasks();
        } catch (e) {
            showToast('Delete failed');
        }
        selectedTaskId = null;
    }

    // Timeline Functions
    function renderTimeline() {
        const container = document.getElementById('timelineContainer');
        if (!container) return;

        if (timelineShape === 'horizontal') {
            renderHorizontalTimeline(container);
        } else if (timelineShape === 'circle') {
            renderCircleTimeline(container);
        } else {
            renderVerticalTimeline(container);
        }
    }

    function getTaskColor(index, total) {
        // Generate slight variations in brightness/saturation for overlapping tasks
        const baseColor = selectedColor;
        const r = parseInt(baseColor.slice(0,2), 16);
        const g = parseInt(baseColor.slice(2,4), 16);
        const b = parseInt(baseColor.slice(4,6), 16);

        const variation = (index / Math.max(total, 1)) * 30 - 15;
        const newR = Math.min(255, Math.max(0, r + variation));
        const newG = Math.min(255, Math.max(0, g + variation));
        const newB = Math.min(255, Math.max(0, b + variation));

        return `rgb(${Math.round(newR)}, ${Math.round(newG)}, ${Math.round(newB)})`;
    }

    function getIndicatorSvg(shape, color) {
        const shapes = {
            circle: `<svg width="8" height="8" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3.5" fill="${color}"/></svg>`,
            triangle: `<svg width="8" height="8" viewBox="0 0 8 8"><path d="M1 4 L7 1 L7 7 Z" fill="${color}"/></svg>`,
            square: `<svg width="8" height="8" viewBox="0 0 8 8"><rect x="1" y="1" width="6" height="6" fill="${color}"/></svg>`,
            heart: `<svg width="8" height="8" viewBox="0 0 8 8"><path d="M4 7 C1 4.5 0 3 0 2 C0 0.5 1 0 2 0 C3 0 4 1 4 1 C4 1 5 0 6 0 C7 0 8 0.5 8 2 C8 3 7 4.5 4 7Z" fill="${color}"/></svg>`
        };
        return shapes[shape] || shapes.circle;
    }

    function renderVerticalTimeline(container) {
        const now = new Date();
        const today = now.toDateString();
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dateLabel = `${monthNames[now.getMonth()]} ${now.getDate()}`;

        const todayStr = getLocalDate();
        const todayTasks = tasks.filter(t => t.date && t.date.split('T')[0] === todayStr);
        const scheduledTasks = todayTasks.filter(t => t.startTime);
        const allDayTasks = todayTasks.filter(t => !t.startTime);

        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const hourHeight = 20;

        let gridHtml = '';
        for (let h = timeStart; h <= timeEnd; h++) {
            gridHtml += `<div class="timeline-hour" data-hour="${h}"><div class="timeline-hour-label">${h}</div><div class="timeline-hour-content" id="hour-${h}"></div></div>`;
        }

        const allDayClick = allDayTasks.length > 0 ? `onclick="showAllDayPopup(event)"` : '';
        container.innerHTML = `
            <div class="timeline-date-label" ${allDayClick} style="cursor:${allDayTasks.length > 0 ? 'pointer' : 'default'}">${dateLabel}${allDayTasks.length > 0 ? ` <span style="font-size:6px;color:#bbb;">(${allDayTasks.length})</span>` : ''}</div>
            <div class="timeline-scroll">
                <div class="timeline-grid" id="timelineGrid">${gridHtml}</div>
            </div>
        `;

        const taskGroups = groupOverlappingTasks(scheduledTasks);

        taskGroups.forEach(group => {
            group.forEach((t, index) => {
                const startMin = timeToMinutes(t.startTime);
                const endMin = t.endTime ? timeToMinutes(t.endTime) : null;
                const startHour = Math.floor(startMin / 60);

                if (startHour < timeStart || startHour > timeEnd) return;

                const hourEl = document.getElementById(`hour-${startHour}`);
                if (!hourEl) return;

                const topOffset = (startMin % 60) / 60 * hourHeight;
                let height, styleClass;

                if (endMin !== null) {
                    const duration = endMin - startMin;
                    height = Math.max(duration / 60 * hourHeight, 12);
                    styleClass = 'solid';
                } else {
                    height = hourHeight * 2;
                    styleClass = 'gradient';
                }

                const taskEl = document.createElement('div');
                taskEl.className = `timeline-task ${styleClass}`;
                taskEl.style.top = topOffset + 'px';
                taskEl.style.height = height + 'px';
                const color = getTaskColor(index, group.length);
                taskEl.style.background = styleClass === 'solid' ? color : `linear-gradient(to bottom, ${color}, transparent)`;
                taskEl.style.borderLeftColor = 'var(--dark-theme-color)';

                const widthPercent = 100 / group.length;
                const leftPercent = index * widthPercent;
                taskEl.style.left = `calc(1px + ${leftPercent}%)`;
                taskEl.style.width = `calc(${widthPercent}% - 2px)`;
                taskEl.style.right = 'auto';

                taskEl.innerHTML = `<div class="task-name">${t.title}</div>`;
                hourEl.appendChild(taskEl);
            });
        });

        if (currentHour >= timeStart && currentHour <= timeEnd) {
            const grid = document.getElementById('timelineGrid');
            const hourOffset = (currentHour - timeStart) * hourHeight;
            const minOffset = currentMinute / 60 * hourHeight;
            const nowTop = hourOffset + minOffset;

            const nowLine = document.createElement('div');
            nowLine.className = 'timeline-now-line';
            nowLine.style.top = nowTop + 'px';
            grid.appendChild(nowLine);

            const nowIndicator = document.createElement('div');
            nowIndicator.className = 'timeline-now-indicator';
            nowIndicator.style.top = (nowTop - 4) + 'px';
            nowIndicator.innerHTML = getIndicatorSvg(indicatorShape, 'var(--dark-theme-color)');
            grid.appendChild(nowIndicator);
        }
    }

    function renderHorizontalTimeline(container) {
        const now = new Date();
        const today = now.toDateString();
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dateLabel = `${monthNames[now.getMonth()]} ${now.getDate()}`;

        const todayStr = getLocalDate();
        const todayTasks = tasks.filter(t => t.date && t.date.split('T')[0] === todayStr);
        const scheduledTasks = todayTasks.filter(t => t.startTime);
        const allDayTasks = todayTasks.filter(t => !t.startTime);

        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const hourWidth = 60;

        let gridHtml = '';
        for (let h = timeStart; h <= timeEnd; h++) {
            gridHtml += `<div class="timeline-h-hour" data-hour="${h}"><span class="timeline-h-hour-label">${h}</span></div>`;
        }

        const allDayClick = allDayTasks.length > 0 ? `onclick="showAllDayPopup(event)"` : '';
        container.innerHTML = `
            <div class="timeline-horizontal">
                <div class="timeline-h-date" ${allDayClick} style="cursor:${allDayTasks.length > 0 ? 'pointer' : 'default'}">${dateLabel}${allDayTasks.length > 0 ? ` <span style="font-size:7px;color:#bbb;">(${allDayTasks.length})</span>` : ''}</div>
                <div class="timeline-h-scroll">
                    <div class="timeline-h-grid" id="timelineHGrid">${gridHtml}</div>
                </div>
            </div>
        `;

        const grid = document.getElementById('timelineHGrid');
        const taskGroups = groupOverlappingTasks(scheduledTasks);

        taskGroups.forEach(group => {
            group.forEach((t, index) => {
                const startMin = timeToMinutes(t.startTime);
                const hasEndTime = !!t.endTime;
                const endMin = hasEndTime ? timeToMinutes(t.endTime) : startMin + 60;
                const startHour = Math.floor(startMin / 60);

                if (startHour < timeStart || startHour > timeEnd) return;

                const leftOffset = (startHour - timeStart) * hourWidth + (startMin % 60) / 60 * hourWidth;
                const duration = endMin - startMin;
                const width = Math.max(duration / 60 * hourWidth, 40);

                const rowHeight = 24;
                const topOffset = 22 + (index * rowHeight);

                const taskEl = document.createElement('div');
                taskEl.className = 'timeline-h-task';
                taskEl.style.left = leftOffset + 'px';
                taskEl.style.width = width + 'px';
                taskEl.style.top = topOffset + 'px';
                taskEl.style.height = '20px';

                // Apply gradient if no end time
                const color = getTaskColor(index, group.length);
                if (hasEndTime) {
                    taskEl.style.background = color;
                } else {
                    taskEl.style.background = `linear-gradient(to right, ${color}, transparent)`;
                }

                taskEl.innerText = t.title;
                grid.appendChild(taskEl);
            });
        });

        if (currentHour >= timeStart && currentHour <= timeEnd) {
            const nowLeft = (currentHour - timeStart) * hourWidth + currentMinute / 60 * hourWidth;
            const nowLine = document.createElement('div');
            nowLine.className = 'timeline-h-now';
            nowLine.style.left = nowLeft + 'px';
            grid.appendChild(nowLine);

            const nowIndicator = document.createElement('div');
            nowIndicator.className = 'timeline-h-now-indicator';
            nowIndicator.style.left = (nowLeft - 4) + 'px';
            nowIndicator.innerHTML = getIndicatorSvg(indicatorShape, 'var(--dark-theme-color)');
            grid.appendChild(nowIndicator);
        }
    }

    function renderCircleTimeline(container) {
        const now = new Date();
        const today = now.toDateString();
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dateLabel = `${monthNames[now.getMonth()]} ${now.getDate()}`;

        const todayStr = getLocalDate();
        const todayTasks = tasks.filter(t => t.date && t.date.split('T')[0] === todayStr);
        const scheduledTasks = todayTasks.filter(t => t.startTime);
        const allDayTasks = todayTasks.filter(t => !t.startTime);

        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();

        const size = 180;
        const center = size / 2;
        const radius = 75;
        const innerRadius = 50;

        let arcsHtml = '';

        for (let h = 0; h < 24; h++) {
            const angle = (h / 24) * 360 - 90;
            const rad = angle * Math.PI / 180;
            const x1 = center + Math.cos(rad) * (radius - 3);
            const y1 = center + Math.sin(rad) * (radius - 3);
            const x2 = center + Math.cos(rad) * radius;
            const y2 = center + Math.sin(rad) * radius;
            arcsHtml += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#eee" stroke-width="1"/>`;

            if (h % 6 === 0) {
                const labelX = center + Math.cos(rad) * (radius + 10);
                const labelY = center + Math.sin(rad) * (radius + 10);
                arcsHtml += `<text x="${labelX}" y="${labelY}" font-size="7" fill="#999" text-anchor="middle" dominant-baseline="middle">${h}</text>`;
            }
        }

        const taskGroups = groupOverlappingTasksCircle(scheduledTasks);

        // Define gradient for tasks without end time
        let gradientDefs = '<defs>';
        let gradientId = 0;

        taskGroups.forEach(group => {
            group.forEach((t, index) => {
                const startMin = timeToMinutes(t.startTime);
                const hasEndTime = !!t.endTime;
                const endMin = hasEndTime ? timeToMinutes(t.endTime) : startMin + 60;

                const layerOffset = index * 8;
                const taskInnerRadius = innerRadius + layerOffset;
                const taskOuterRadius = Math.min(taskInnerRadius + 8, radius - 2);

                const startAngle = (startMin / (24 * 60)) * 360 - 90;
                const endAngle = (endMin / (24 * 60)) * 360 - 90;

                const startRad = startAngle * Math.PI / 180;
                const endRad = endAngle * Math.PI / 180;

                const x1 = center + Math.cos(startRad) * taskInnerRadius;
                const y1 = center + Math.sin(startRad) * taskInnerRadius;
                const x2 = center + Math.cos(endRad) * taskInnerRadius;
                const y2 = center + Math.sin(endRad) * taskInnerRadius;
                const x3 = center + Math.cos(endRad) * taskOuterRadius;
                const y3 = center + Math.sin(endRad) * taskOuterRadius;
                const x4 = center + Math.cos(startRad) * taskOuterRadius;
                const y4 = center + Math.sin(startRad) * taskOuterRadius;

                const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
                const color = getTaskColor(index, group.length);

                let fillAttr;
                if (hasEndTime) {
                    fillAttr = `fill="${color}" opacity="0.7"`;
                } else {
                    // Create gradient for no end time
                    const gId = `grad${gradientId++}`;
                    gradientDefs += `<linearGradient id="${gId}" gradientUnits="userSpaceOnUse" x1="${x1}" y1="${y1}" x2="${x3}" y2="${y3}"><stop offset="0%" stop-color="${color}" stop-opacity="0.7"/><stop offset="100%" stop-color="${color}" stop-opacity="0.1"/></linearGradient>`;
                    fillAttr = `fill="url(#${gId})"`;
                }

                // Add title element for hover
                arcsHtml += `<path d="M${x1},${y1} A${taskInnerRadius},${taskInnerRadius} 0 ${largeArc},1 ${x2},${y2} L${x3},${y3} A${taskOuterRadius},${taskOuterRadius} 0 ${largeArc},0 ${x4},${y4} Z" ${fillAttr} style="cursor:pointer"><title>${t.title}</title></path>`;
            });
        });

        gradientDefs += '</defs>';

        const nowAngle = ((currentHour * 60 + currentMinute) / (24 * 60)) * 360 - 90;
        const nowRad = nowAngle * Math.PI / 180;
        const nowX = center + Math.cos(nowRad) * (radius + 3);
        const nowY = center + Math.sin(nowRad) * (radius + 3);
        arcsHtml += `<circle cx="${nowX}" cy="${nowY}" r="3" fill="var(--dark-theme-color)"/>`;
        arcsHtml += `<line x1="${center}" y1="${center}" x2="${center + Math.cos(nowRad) * innerRadius}" y2="${center + Math.sin(nowRad) * innerRadius}" stroke="var(--dark-theme-color)" stroke-width="1.5"/>`;

        const allDayClick = allDayTasks.length > 0 ? `onclick="showAllDayPopup(event)"` : '';
        container.innerHTML = `
            <div class="timeline-circle">
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                    ${gradientDefs}
                    <circle cx="${center}" cy="${center}" r="${radius}" fill="none" stroke="#eee" stroke-width="1"/>
                    <circle cx="${center}" cy="${center}" r="${innerRadius}" fill="none" stroke="#eee" stroke-width="1"/>
                    ${arcsHtml}
                </svg>
                <div class="circle-date" ${allDayClick}>${dateLabel}${allDayTasks.length > 0 ? ` (${allDayTasks.length})` : ''}</div>
            </div>
        `;
    }

    function groupOverlappingTasks(tasks) {
        if (tasks.length === 0) return [];

        const sorted = [...tasks].sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
        const groups = [];
        let currentGroup = [sorted[0]];
        let currentEnd = sorted[0].endTime ? timeToMinutes(sorted[0].endTime) : timeToMinutes(sorted[0].startTime) + 60;

        for (let i = 1; i < sorted.length; i++) {
            const taskStart = timeToMinutes(sorted[i].startTime);
            if (taskStart < currentEnd) {
                currentGroup.push(sorted[i]);
                const taskEnd = sorted[i].endTime ? timeToMinutes(sorted[i].endTime) : taskStart + 60;
                currentEnd = Math.max(currentEnd, taskEnd);
            } else {
                groups.push(currentGroup);
                currentGroup = [sorted[i]];
                currentEnd = sorted[i].endTime ? timeToMinutes(sorted[i].endTime) : taskStart + 60;
            }
        }
        groups.push(currentGroup);

        return groups;
    }

    function groupOverlappingTasksCircle(tasks) {
        // For circle, return all tasks as one group to layer them
        if (tasks.length === 0) return [];
        return [tasks];
    }

    function timeToMinutes(timeStr) {
        if (!timeStr) return 0;
        const parts = timeStr.split(':');
        return parseInt(parts[0]) * 60 + parseInt(parts[1] || 0);
    }

    // Calendar Functions
    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        if (!container) return;
        renderCalendarContent(container, calendarDate, weekStart, tasks, true);
    }

    function renderCalendarContent(container, date, startDay, taskList, interactive) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        const dayLabels = startDay === 'sun' ? ['S', 'M', 'T', 'W', 'T', 'F', 'S'] : ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let startOffset = firstDay.getDay();
        if (startDay === 'mon') startOffset = startOffset === 0 ? 6 : startOffset - 1;

        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

        const eventDates = new Map();
        const priorityDates = new Set();
        if (Array.isArray(taskList)) {
            taskList.forEach(t => {
                if (t.date) {
                    // Normalize date to YYYY-MM-DD format for consistent comparison
                    const normalizedDate = t.date.split('T')[0];
                    if (!eventDates.has(normalizedDate)) eventDates.set(normalizedDate, []);
                    eventDates.get(normalizedDate).push(t);
                    if (t.priority) priorityDates.add(normalizedDate);
                }
            });
        }

        let datesHtml = '';
        const prevMonth = new Date(year, month, 0);
        for (let i = startOffset - 1; i >= 0; i--) {
            datesHtml += `<div class="calendar-date other-month">${prevMonth.getDate() - i}</div>`;
        }

        for (let d = 1; d <= lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isToday = dateStr === todayStr;
            const hasEvent = eventDates.has(dateStr);
            const hasPriority = priorityDates.has(dateStr);
            let classes = 'calendar-date';
            if (isToday) classes += ' today';
            if (hasEvent) classes += ' has-event';
            if (hasPriority) classes += ' has-priority';
            const clickAttr = interactive && hasEvent ? `onclick="showCalendarPopup(event, '${dateStr}')"` : '';
            datesHtml += `<div class="${classes}" ${clickAttr}>${d}</div>`;
        }

        const totalCells = startOffset + lastDay.getDate();
        const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let d = 1; d <= remaining; d++) {
            datesHtml += `<div class="calendar-date other-month">${d}</div>`;
        }

        container.innerHTML = `
            <div class="calendar-header">
                <button class="calendar-nav-btn" onclick="changeMonth(-1)">‹</button>
                <span class="calendar-month">${monthNames[month]}</span>
                <button class="calendar-nav-btn" onclick="changeMonth(1)">›</button>
            </div>
            <div class="calendar-year">${year}</div>
            <div class="calendar-days">${dayLabels.map(d => `<div class="calendar-day-label">${d}</div>`).join('')}</div>
            <div class="calendar-dates">${datesHtml}</div>
        `;
    }

    function showCalendarPopup(e, dateStr) {
        e.stopPropagation();
        selectedDateStr = dateStr;

        const popup = document.getElementById('calendarPopup');
        if (!popup) return;

        const dateTasks = tasks.filter(t => t.date === dateStr);
        if (dateTasks.length === 0) return;

        dateTasks.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));

        const d = new Date(dateStr);
        const monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const title = `${monthNamesShort[d.getMonth()]} ${d.getDate()}`;

        popup.innerHTML = `
            <div class="calendar-popup-title">${title}</div>
            ${dateTasks.map(t => `
                <div class="calendar-popup-item">
                    <span class="star-mini ${t.priority ? 'active' : ''}" onclick="togglePriorityFromPopup(event, '${t.id}')">
                        <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </span>
                    <span class="dot"></span>
                    ${t.startTime ? '<span style="color:#999;font-size:7px;">' + t.startTime.substring(0,5) + '</span>' : ''}
                    <span class="item-title">${t.title}</span>
                </div>
            `).join('')}
        `;

        const rect = e.target.getBoundingClientRect();
        const containerRect = document.getElementById('calendarContainer').getBoundingClientRect();
        const widgetRect = document.getElementById('calendarWidget').getBoundingClientRect();

        // Calculate position relative to container
        let left = rect.left - containerRect.left;
        let top = rect.bottom - containerRect.top + 4;

        // Constrain within widget bounds
        const popupWidth = 140;
        const popupHeight = 120;

        if (left + popupWidth > containerRect.width) {
            left = containerRect.width - popupWidth - 8;
        }
        if (left < 0) left = 4;

        if (top + popupHeight > widgetRect.height - containerRect.top + widgetRect.top - 8) {
            top = rect.top - containerRect.top - popupHeight - 4;
        }
        if (top < 0) top = 4;

        popup.style.left = left + 'px';
        popup.style.top = top + 'px';
        popup.classList.add('show');
    }

    function hideCalendarPopup() {
        const popup = document.getElementById('calendarPopup');
        if (popup) popup.classList.remove('show');
    }

    function showAllDayPopup(e) {
        e.stopPropagation();
        const popup = document.getElementById('allDayPopup');
        if (!popup) return;

        const now = new Date();
        const todayStr = getLocalDate();
        const allDayTasks = tasks.filter(t => t.date && t.date.split('T')[0] === todayStr && !t.startTime);

        if (allDayTasks.length === 0) return;

        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const title = `${monthNames[now.getMonth()]} ${now.getDate()} - All Day`;

        popup.innerHTML = `
            <div class="allday-popup-title">${title}</div>
            ${allDayTasks.map(t => `
                <div class="allday-popup-item">
                    <span class="dot"></span>
                    <span>${t.title}</span>
                </div>
            `).join('')}
        `;

        popup.style.top = '30px';
        popup.style.left = '10px';
        popup.classList.add('show');
    }

    function hideAllDayPopup() {
        const popup = document.getElementById('allDayPopup');
        if (popup) popup.classList.remove('show');
    }

    async function togglePriorityFromPopup(e, id) {
        e.stopPropagation();
        await togglePriority(id);
        renderCalendar();
        if (selectedDateStr) {
            // Re-show popup with updated data
            const dateTasks = tasks.filter(t => t.date === selectedDateStr);
            if (dateTasks.length > 0) {
                const popup = document.getElementById('calendarPopup');
                const d = new Date(selectedDateStr);
                const monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const title = `${monthNamesShort[d.getMonth()]} ${d.getDate()}`;
                dateTasks.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
                popup.innerHTML = `
                    <div class="calendar-popup-title">${title}</div>
                    ${dateTasks.map(t => `
                        <div class="calendar-popup-item">
                            <span class="star-mini ${t.priority ? 'active' : ''}" onclick="togglePriorityFromPopup(event, '${t.id}')">
                                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            </span>
                            <span class="dot"></span>
                            ${t.startTime ? '<span style="color:#999;font-size:7px;">' + t.startTime.substring(0,5) + '</span>' : ''}
                            <span class="item-title">${t.title}</span>
                        </div>
                    `).join('')}
                `;
            }
        }
    }

    function changeMonth(delta) {
        calendarDate.setMonth(calendarDate.getMonth() + delta);
        if (widgetType === 'calendar') renderCalendar();
        else renderPreviewCalendar();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
</script>
</body>
</html>
